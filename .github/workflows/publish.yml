name: Build and Publish

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build and publish'
        required: true
        default: 'main'
        type: choice
        options:
          - main
          - develop
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string
      release_notes:
        description: 'Release notes (optional)'
        required: false
        type: string
        default: 'Automated release'
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
        
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3
        
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      - name: Run tests
        run: ./gradlew test --continue
        
      - name: Build library
        run: ./gradlew build
        
      - name: Generate vendor dependency JSON
        run: ./gradlew vendordepJson
        
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            build/outputs/
            build/repos/MWLib.json
          retention-days: 30
          
      - name: Upload build reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-reports
          path: |
            build/reports/
            build/test-results/
          retention-days: 30

  publish:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      
    steps:
      - name: Debug publish conditions
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Branch: ${{ inputs.branch }}"
          echo "Version: ${{ inputs.version }}"
          echo "Should publish: true"
          
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 0
        
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3
        
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      - name: Extract version from input
        id: version
        run: |
          VERSION=${{ inputs.version }}
          # Remove 'v' prefix if present
          VERSION=${VERSION#v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=v${VERSION}" >> $GITHUB_OUTPUT
          
      - name: Update version in publish.gradle
        run: |
          sed -i "s/def pubVersion = '.*'/def pubVersion = '${{ steps.version.outputs.version }}'/" publish.gradle
          
      - name: Build and publish to GitHub Packages
        run: ./gradlew build publish --info
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Create Git tag
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag ${{ steps.version.outputs.tag }}
          git push origin ${{ steps.version.outputs.tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          release_name: Release ${{ steps.version.outputs.tag }}
          body: ${{ inputs.release_notes }}
          draft: false
          prerelease: ${{ inputs.prerelease }}
          
      - name: Upload vendor dependency to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./build/repos/MWLib.json
          asset_name: MWLib.json
          asset_content_type: application/json